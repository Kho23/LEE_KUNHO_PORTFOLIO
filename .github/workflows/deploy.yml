name: Backend Deploy to EC2

on:
  push:
    branches: [ "main" ]
    paths:
      - 'backend/**'
      - 'deploy.sh'
      - '.github/workflows/**'  # 설정 파일 변경 시에도 액션이 실행되도록 추가

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. 코드 체크아웃
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. JDK 17 설치
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3. Gradle 빌드
    - name: Build with Gradle
      run: |
        cd backend
        chmod +x gradlew
        ./gradlew clean bootJar -x test

    # 4. [중요] 파일을 밖으로 꺼내서 경로 문제 해결
    - name: Move JAR to Root
      run: |
        # 파일명을 project.jar로 통일해서 경로 복잡성을 없앱니다.
        mv backend/build/libs/backend-0.0.1-SNAPSHOT.jar ./project.jar
        echo "✅ JAR 파일 준비 완료"
        ls -al project.jar

    # 5. JAR 파일 전송 (파일 이름만 딱 지정)
    - name: Copy JAR to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        source: "project.jar"
        target: "/home/ubuntu/app"
        # 최상위 파일을 보내므로 strip_components는 필요 없습니다.

    # 6. deploy.sh 스크립트 전송
    - name: Copy Script to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        source: "deploy.sh"
        target: "/home/ubuntu/app"

    # 7. 원격 서버에서 배포 스크립트 실행
    - name: Execute Deploy Script
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        script: |
          # 윈도우 줄바꿈 문자 제거 및 권한 부여
          sed -i 's/\r$//' /home/ubuntu/app/deploy.sh
          chmod +x /home/ubuntu/app/deploy.sh
          
          # deploy.sh 내의 JAR_NAME 변수를 project.jar로 강제 고정 (오타 방지)
          sed -i 's/JAR_NAME=.*/JAR_NAME="project.jar"/' /home/ubuntu/app/deploy.sh
          
          # 배포 실행
          /home/ubuntu/app/deploy.sh