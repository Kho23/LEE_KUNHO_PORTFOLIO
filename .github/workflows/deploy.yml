name: Backend Deploy to EC2

on:
  push:
    branches: [ "main" ]
    paths:
      - 'backend/**'    # ë°±ì—”ë“œ ì½”ë“œê°€ ë°”ë€Œê±°ë‚˜
      - 'deploy.sh'     # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ê°€ ë°”ë€Œë©´ ì‹¤í–‰

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    # 1. Gradle ë¹Œë“œ (backend í´ë”ì—ì„œ ì‹¤í–‰)
    - name: Build with Gradle
      run: |
        cd backend
        chmod +x gradlew
        ./gradlew clean build -x test

    # 2. ë¹Œë“œ ê²°ê³¼ í™•ì¸ (ë¡œê·¸ìš©)
    - name: Check build result
      run: |
        echo "ğŸ“‚ ìƒì„±ëœ JAR íŒŒì¼ í™•ì¸:"
        ls -al backend/build/libs

    # 3. JAR íŒŒì¼ ì „ì†¡ (ê»ë°ê¸° í´ë” ë²—ê²¨ë‚´ê³  ì•Œë§¹ì´ë§Œ)
    - name: Copy JAR to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        source: "backend/build/libs/*.jar"
        target: "/home/ubuntu/app"
        strip_components: 3

    # 4. deploy.sh ìŠ¤í¬ë¦½íŠ¸ ì „ì†¡ (ë£¨íŠ¸ í´ë”ì— ìˆëŠ” ê²ƒ)
    - name: Copy Script to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        source: "deploy.sh"
        target: "/home/ubuntu/app"

    # 5. ì›ê²© ì„œë²„ì—ì„œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    - name: Execute Deploy Script
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        script: |
          # í˜¹ì‹œ ëª¨ë¥¼ plain íŒŒì¼(ê»ë°ê¸°) ì‚­ì œ
          rm -f /home/ubuntu/app/*-plain.jar
          
          # ìœˆë„ìš° ì‘ì„± íŒŒì¼ ì¤„ë°”ê¿ˆ ë¬¸ì(\r) ì œê±° (ì—ëŸ¬ ë°©ì§€ìš© ì•ˆì „ì¥ì¹˜)
          sed -i 's/\r$//' /home/ubuntu/app/deploy.sh
          
          # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x /home/ubuntu/app/deploy.sh
          
          # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          /home/ubuntu/app/deploy.sh