name: Backend Deploy to EC2

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'README.md'
      - '.gitignore'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 1. ë¹Œë“œ
    - name: Build with Gradle
      run: |
        cd backend
        chmod +x gradlew
        ./gradlew clean bootJar -x test

    # 2. íŒŒì¼ ìˆ˜ì§‘
    - name: Prepare files for transfer
      run: |
        find . -name "backend-0.0.1-SNAPSHOT.jar" -exec cp {} ./project.jar \;
        find . -name "deploy.sh" -exec cp {} ./deploy.sh \;
        echo "ğŸ“‚ ì¤€ë¹„ ì™„ë£Œ íŒŒì¼ ëª©ë¡:"
        ls -al project.jar deploy.sh

    # 3. íŒŒì¼ ì „ì†¡
    - name: Copy Files to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        source: "project.jar,deploy.sh"
        target: "/home/ubuntu/app"

    # 4. ì„œë²„ì—ì„œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    - name: Execute Deploy Script
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        # ì¤‘ìš”: ë³€ìˆ˜ ì‚¬ì´ì— ê³µë°± ì—†ì´ ì½¤ë§ˆë¡œë§Œ ì—°ê²°í•´ì•¼ í•©ë‹ˆë‹¤.
        envs: RDS_URL,RDS_USERNAME,RDS_PASSWORD,GOOGLE_KEY,JWT_SECRET,KAKAO_CLIENT_ID,KAKAO_CLIENT_SECRET,NAVER_CLIENT_ID,NAVER_CLIENT_SECRET,IAMPORT_API_KEY,IAMPORT_API_SECRET
        script: |
          mkdir -p /home/ubuntu/app
          cd /home/ubuntu/app
          
          if [ -f "deploy.sh" ]; then
            sed -i 's/\r$//' deploy.sh
            chmod +x deploy.sh
            sed -i 's/JAR_NAME=.*/JAR_NAME="project.jar"/' deploy.sh
            
            # í™˜ê²½ë³€ìˆ˜ê°€ ë¹„ì–´ìˆëŠ”ì§€ ë§ˆì§€ë§‰ìœ¼ë¡œ í™•ì¸ (ë””ë²„ê¹…ìš©)
            if [ -z "$RDS_URL" ]; then
              echo "âŒ ì—ëŸ¬: RDS_URL í™˜ê²½ë³€ìˆ˜ê°€ ì„œë²„ì— ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              exit 1
            fi
            
            ./deploy.sh
          else
            echo "âŒ ì—ëŸ¬: deploy.sh íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
      env:
        RDS_URL: ${{ secrets.RDS_URL }}
        RDS_USERNAME: ${{ secrets.RDS_USERNAME }}
        RDS_PASSWORD: ${{ secrets.RDS_PASSWORD }}
        GOOGLE_KEY: ${{ secrets.GOOGLE_KEY }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
        KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
        NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
        NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
        IAMPORT_API_KEY: ${{ secrets.IAMPORT_API_KEY }}
        IAMPORT_API_SECRET: ${{ secrets.IAMPORT_API_SECRET }}