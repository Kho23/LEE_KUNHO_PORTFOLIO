name: Backend Deploy to EC2

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'README.md'
      - '.gitignore'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 1. ë¹Œë“œ (backend í´ë” ì§„ì…)
    - name: Build with Gradle
      run: |
        cd backend
        chmod +x gradlew
        ./gradlew clean bootJar -x test

    # 2. [íŒŒì¼ ì¤€ë¹„] ë‚´ ì»´í“¨í„° ì•ˆì˜ íŒŒì¼ë“¤ì„ ìµœìƒìœ„ë¡œ ëª¨ìœ¼ê¸°
    - name: Prepare files for transfer
      run: |
        find . -name "backend-0.0.1-SNAPSHOT.jar" -exec cp {} ./project.jar \;
        # ë‚´ ì»´í“¨í„° í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ìˆëŠ” deploy.shë¥¼ ì°¾ì•„ì„œ ë³µì‚¬
        find . -name "deploy.sh" -exec cp {} ./deploy.sh \;
        echo "ğŸ“‚ ë‚´ ì»´í“¨í„°ì—ì„œ ì¤€ë¹„ëœ íŒŒì¼:"
        ls -al project.jar deploy.sh

    # 3. íŒŒì¼ ì „ì†¡ (ì„œë²„ì˜ /home/ubuntu/app/ í´ë”ë¡œ ì „ì†¡)
    - name: Copy Files to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        source: "project.jar,deploy.sh"
        target: "/home/ubuntu/app"

    # 4. ì„œë²„ì—ì„œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    - name: Execute Deploy Script
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        envs: RDS_URL,RDS_USERNAME,RDS_PASSWORD,GOOGLE_KEY,JWT_SECRET,KAKAO_CLIENT_ID,KAKAO_CLIENT_SECRET,NAVER_CLIENT_ID,NAVER_CLIENT_SECRET,IAMPORT_API_KEY,IAMPORT_API_SECRET
        script: |
          # ì„œë²„ í´ë”ê°€ ì—†ìœ¼ë©´ ìƒì„±í•˜ê³  ì§„ì…
          mkdir -p /home/ubuntu/app
          cd /home/ubuntu/app
          
          # ì „ì†¡ëœ íŒŒì¼ì´ ìˆëŠ”ì§€ ëª©ë¡ í™•ì¸ (ë¡œê·¸ìš©)
          echo "ğŸ“‚ ì„œë²„ì— ë“¤ì–´ì˜¨ íŒŒì¼ ëª©ë¡:"
          ls -al
          
          # deploy.sh íŒŒì¼ì´ ë³´ì´ë©´ ì‹¤í–‰
          if [ -f "deploy.sh" ]; then
            sed -i 's/\r$//' deploy.sh
            chmod +x deploy.sh
            # ìŠ¤í¬ë¦½íŠ¸ ë‚´ JAR_NAMEì„ project.jarë¡œ ìë™ ìˆ˜ì •
            sed -i 's/JAR_NAME=.*/JAR_NAME="project.jar"/' deploy.sh
            ./deploy.sh
          else
            echo "âŒ ì—ëŸ¬: ì„œë²„ì— deploy.sh íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ì „ì†¡ ë‹¨ê³„ë¥¼ í™•ì¸í•˜ì„¸ìš”."
            exit 1
          fi
      env:
        RDS_URL: ${{ secrets.RDS_URL }}
        RDS_USERNAME: ${{ secrets.RDS_USERNAME }}
        RDS_PASSWORD: ${{ secrets.RDS_PASSWORD }}
        GOOGLE_KEY: ${{ secrets.GOOGLE_KEY }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
        KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
        NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
        NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
        IAMPORT_API_KEY: ${{ secrets.IAMPORT_API_KEY }}
        IAMPORT_API_SECRET: ${{ secrets.IAMPORT_API_SECRET }}