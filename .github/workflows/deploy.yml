name: Backend Deploy to EC2

on:
  push:
    branches: [ "main" ]
    paths:
      - 'backend/**' # backend í´ë”ê°€ ë°”ë€” ë•Œë§Œ ì‹¤í–‰

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    # [ìˆ˜ì •] backend í´ë”ë¡œ ë“¤ì–´ê°€ì„œ ë¹Œë“œ (ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•)
    - name: Build with Gradle
      run: |
        cd backend
        chmod +x gradlew
        ./gradlew clean build -x test

    # [ì¶”ê°€] íŒŒì¼ì´ ì˜ ìƒê²¼ëŠ”ì§€ ëˆˆìœ¼ë¡œ í™•ì¸ (ë””ë²„ê¹…ìš©)
    - name: Check build result
      run: |
        echo "ğŸ“‚ ìƒì„±ëœ JAR íŒŒì¼ í™•ì¸:"
        ls -al backend/build/libs

    # [ìˆ˜ì •] backend/build/libs ê²½ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    - name: Copy JAR to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        source: "backend/build/libs/*.jar"
        target: "/home/ubuntu/app"
        strip_components: 3

    - name: Execute Deploy Script
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        script: |
          # 1. app í´ë”ì— ë“¤ì–´ì˜¨ project.jarë¥¼ ì‹¤í–‰ ìœ„ì¹˜ë¡œ ì´ë™ì‹œí‚¤ë©° ì´ë¦„ ë³€ê²½
          # -f ì˜µì…˜ì€ ê¸°ì¡´ íŒŒì¼ì´ ìˆìœ¼ë©´ ê°•ì œë¡œ ë®ì–´ì“°ë¼ëŠ” ëœ»ì…ë‹ˆë‹¤.
          mv -f /home/ubuntu/app/project.jar /home/ubuntu/backend-0.0.1-SNAPSHOT.jar
          
          # 2. ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ (í˜¹ì‹œ ëª¨ë¥´ë‹ˆ í•œë²ˆ ë”)
          chmod +x /home/ubuntu/deploy.sh
          
          # 3. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          ./deploy.sh