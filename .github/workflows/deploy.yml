name: Backend Deploy to EC2

on:
  push:
    branches: [ "main" ]
    paths:
      - 'backend/**' # backend í´ë”ê°€ ë°”ë€” ë•Œë§Œ ì‹¤í–‰

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    # [ìˆ˜ì •] backend í´ë”ë¡œ ë“¤ì–´ê°€ì„œ ë¹Œë“œ (ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•)
    - name: Build with Gradle
      run: |
        cd backend
        chmod +x gradlew
        ./gradlew clean build -x test

    # [ì¶”ê°€] íŒŒì¼ì´ ì˜ ìƒê²¼ëŠ”ì§€ ëˆˆìœ¼ë¡œ í™•ì¸ (ë””ë²„ê¹…ìš©)
    - name: Check build result
      run: |
        echo "ğŸ“‚ ìƒì„±ëœ JAR íŒŒì¼ í™•ì¸:"
        ls -al backend/build/libs

    # [ìˆ˜ì •] backend/build/libs ê²½ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    - name: Copy JAR to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        source: "backend/build/libs/*.jar"
        target: "/home/ubuntu/app"
        strip_components: 3

    - name: Execute Deploy Script
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        script: |
          # 1. ê¸°ì¡´ íŒŒì¼ ì •ë¦¬
          rm -f /home/ubuntu/backend-0.0.1-SNAPSHOT.jar
          
          # 2. ì „ì†¡ëœ íŒŒì¼ì„ í™ˆ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ë° ì´ë¦„ ë³€ê²½
          mv /home/ubuntu/app/*.jar /home/ubuntu/backend-0.0.1-SNAPSHOT.jar
          
          # 3. deploy.sh ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ë° ì‹¤í–‰
          chmod +x ./deploy.sh
          ./deploy.sh