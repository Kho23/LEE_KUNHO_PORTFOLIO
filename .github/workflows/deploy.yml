name: Backend Deploy to EC2

on:
  push:
    branches: [ "main" ]
    paths:
      - 'backend/**'
      - 'deploy.sh'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. JDK 17 ì„¤ì¹˜
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 3. Gradle ë¹Œë“œ (tar ì—ëŸ¬ í•´ê²°ì˜ í•µì‹¬!)
    - name: Build with Gradle
      run: |
        cd backend
        chmod +x gradlew
        ./gradlew clean bootJar -x test

    # 4. ë¹Œë“œ ê²°ê³¼ í™•ì¸ (ë””ë²„ê¹…ìš©)
    - name: Check build result
      run: |
        echo "ğŸ“‚ JAR íŒŒì¼ ìœ„ì¹˜ í™•ì¸:"
        ls -al backend/build/libs

    # 5. JAR íŒŒì¼ ì „ì†¡ (ë³€ìˆ˜ëª… HOST, USERNAME, KEY ë¡œ ë³µêµ¬)
    - name: Copy JAR to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        source: "backend/build/libs/backend-0.0.1-SNAPSHOT.jar"
        target: "/home/ubuntu/app"
        strip_components: 3

    - name: Debug - Check File Existence
      run: |
        echo "=== í˜„ì¬ ë””ë ‰í† ë¦¬ ìœ„ì¹˜ ==="
        pwd
        echo "=== backend í´ë” ë‚´ìš©ë¬¼ ==="
        ls -al backend
        echo "=== build í´ë” ë‚´ìš©ë¬¼ ==="
        ls -R backend/build

    # 6. deploy.sh ìŠ¤í¬ë¦½íŠ¸ ì „ì†¡
    - name: Copy Script to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        source: "deploy.sh"
        target: "/home/ubuntu/app"

    # 7. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    - name: Execute Deploy Script
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        script: |
          # 1. ê»ë°ê¸° íŒŒì¼(plain jar) ì‚­ì œ
          rm -f /home/ubuntu/app/*-plain.jar
          
          # 2. ìœˆë„ìš° ì¤„ë°”ê¿ˆ ë¬¸ì ì œê±° (í•„ìˆ˜)
          sed -i 's/\r$//' /home/ubuntu/app/deploy.sh
          
          # 3. ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x /home/ubuntu/app/deploy.sh
          
          # 4. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          /home/ubuntu/app/deploy.sh