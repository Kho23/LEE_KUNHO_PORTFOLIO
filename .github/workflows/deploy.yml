name: Backend Deploy to EC2

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'README.md'
      - '.gitignore'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 1. ÎπåÎìú (backend Ìè¥Îçî ÏßÑÏûÖ)
    - name: Build with Gradle
      run: |
        cd backend
        chmod +x gradlew
        ./gradlew clean bootJar -x test

    # 2. [ÌååÏùº Ï§ÄÎπÑ] JARÏôÄ Ïä§ÌÅ¨Î¶ΩÌä∏Î•º ÏµúÏÉÅÏúÑÎ°ú Î≥µÏÇ¨
    - name: Prepare files for transfer
      run: |
        find . -name "backend-0.0.1-SNAPSHOT.jar" -exec cp {} ./project.jar \;
        find . -name "deploy.sh" -exec cp {} ./deploy.sh \;
        echo "üìÇ Ï†ÑÏÜ° Ï§ÄÎπÑ ÏôÑÎ£å"

    # 3. ÌååÏùº Ï†ÑÏÜ°
    - name: Copy Files to EC2
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        source: "project.jar,deploy.sh"
        target: "/home/ubuntu/app"

    # 4. ÏÑúÎ≤ÑÏóêÏÑú Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§Ìñâ (Ï†ÑÎã¨Î∞õÏùÄ Secrets Ï£ºÏûÖ)
    - name: Execute Deploy Script
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: 22
        envs: RDS_URL,RDS_USERNAME,RDS_PASSWORD,GOOGLE_KEY,JWT_SECRET,KAKAO_CLIENT_ID,KAKAO_CLIENT_SECRET,NAVER_CLIENT_ID,NAVER_CLIENT_SECRET,IAMPORT_API_KEY,IAMPORT_API_SECRET
        script: |
          cd /home/ubuntu/app
          sed -i 's/\r$//' deploy.sh
          chmod +x deploy.sh
          sed -i 's/JAR_NAME=.*/JAR_NAME="project.jar"/' deploy.sh
          ./deploy.sh
      env:
        RDS_URL: ${{ secrets.RDS_URL }}
        RDS_USERNAME: ${{ secrets.RDS_USERNAME }}
        RDS_PASSWORD: ${{ secrets.RDS_PASSWORD }}
        GOOGLE_KEY: ${{ secrets.GOOGLE_KEY }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
        KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
        NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
        NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
        IAMPORT_API_KEY: ${{ secrets.IAMPORT_API_KEY }}
        IAMPORT_API_SECRET: ${{ secrets.IAMPORT_API_SECRET }}